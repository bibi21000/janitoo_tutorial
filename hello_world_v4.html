<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>HelloWord V4 &mdash; janitoo_tutorial 0.0.7 documentation</title>
    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinxcontrib-images/LightBox2/lightbox2/css/lightbox.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootswatch-3.3.4/united/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.0.7',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/sphinxcontrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="_static/sphinxcontrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
    <script type="text/javascript" src="_static/sphinxcontrib-images/LightBox2/lightbox2-customize/jquery-noconflict.js"></script>
    <script type="text/javascript" src="_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-3.3.4/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="janitoo_tutorial 0.0.7 documentation" href="index.html" />
    <link rel="next" title="Create and share" href="more.html" />
    <link rel="prev" title="Discovering network" href="discovering_network.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">
          janitoo_tutorial</a>
        <span class="navbar-text navbar-version pull-left"><b>0.0.7</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="tools/index.html">Tools</a></li>
                <li><a href="api/index.html">Reference</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="preface.html"> What is Janitoo</a><ul>
<li class="toctree-l2"><a class="reference internal" href="preface.html#preface">Preface</a></li>
<li class="toctree-l2"><a class="reference internal" href="preface.html#about-this-tutorial">About this tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="preface.html#notes">Notes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="install.html"> Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="install.html#goal">Goal</a></li>
<li class="toctree-l2"><a class="reference internal" href="install.html#needed-tools">Needed tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="install.html#initial-clone">Initial clone</a></li>
<li class="toctree-l2"><a class="reference internal" href="install.html#update-your-clone">Update your clone</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="hello_world_v0.html"> Hello World : connect everything</a><ul>
<li class="toctree-l2"><a class="reference internal" href="hello_world_v0.html#goal">Goal</a></li>
<li class="toctree-l2"><a class="reference internal" href="hello_world_v0.html#needed-parts">Needed parts</a></li>
<li class="toctree-l2"><a class="reference internal" href="hello_world_v0.html#fritzing">Fritzing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="hello_world_v1.html"> Hello World 1 : a simple server</a><ul>
<li class="toctree-l2"><a class="reference internal" href="hello_world_v1.html#goal">Goal</a></li>
<li class="toctree-l2"><a class="reference internal" href="hello_world_v1.html#configuration">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="hello_world_v1.html#test-it">Test it</a></li>
<li class="toctree-l2"><a class="reference internal" href="hello_world_v1.html#launch-it">Launch it</a></li>
<li class="toctree-l2"><a class="reference internal" href="hello_world_v1.html#query-it">Query it</a></li>
<li class="toctree-l2"><a class="reference internal" href="hello_world_v1.html#performances">Performances</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="hello_world_v2.html"> Hello World 2 : an advanced server</a><ul>
<li class="toctree-l2"><a class="reference internal" href="hello_world_v2.html#goal">Goal</a></li>
<li class="toctree-l2"><a class="reference internal" href="hello_world_v2.html#the-components">The components</a></li>
<li class="toctree-l2"><a class="reference internal" href="hello_world_v2.html#the-bus">The bus</a></li>
<li class="toctree-l2"><a class="reference internal" href="hello_world_v2.html#the-thread">The thread</a></li>
<li class="toctree-l2"><a class="reference internal" href="hello_world_v2.html#entry-points">Entry-points</a></li>
<li class="toctree-l2"><a class="reference internal" href="hello_world_v2.html#configuration">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="hello_world_v2.html#test-it">Test it</a></li>
<li class="toctree-l2"><a class="reference internal" href="hello_world_v2.html#launch-it">Launch it</a></li>
<li class="toctree-l2"><a class="reference internal" href="hello_world_v2.html#performances">Performances</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="hello_world_v3.html"> Hello World 3 : a more advanced server</a><ul>
<li class="toctree-l2"><a class="reference internal" href="hello_world_v3.html#goal">Goal</a></li>
<li class="toctree-l2"><a class="reference internal" href="hello_world_v3.html#the-bus">The bus</a></li>
<li class="toctree-l2"><a class="reference internal" href="hello_world_v3.html#the-finish-state-machine">The finish state machine</a></li>
<li class="toctree-l2"><a class="reference internal" href="hello_world_v3.html#create-a-server">Create a server</a></li>
<li class="toctree-l2"><a class="reference internal" href="hello_world_v3.html#spy-it">Spy it</a></li>
<li class="toctree-l2"><a class="reference internal" href="hello_world_v3.html#start-it-at-boot">Start it at boot</a></li>
<li class="toctree-l2"><a class="reference internal" href="hello_world_v3.html#performances">Performances</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="many_servers.html"> Many servers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="many_servers.html#goal">Goal</a></li>
<li class="toctree-l2"><a class="reference internal" href="many_servers.html#mosquitto">Mosquitto</a></li>
<li class="toctree-l2"><a class="reference internal" href="many_servers.html#the-docker-appliance">The docker appliance</a></li>
<li class="toctree-l2"><a class="reference internal" href="many_servers.html#the-network">The network</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="discovering_network.html"> Discovering the network</a><ul>
<li class="toctree-l2"><a class="reference internal" href="discovering_network.html#goal">Goal</a></li>
<li class="toctree-l2"><a class="reference internal" href="discovering_network.html#one-more-server">One more server</a></li>
<li class="toctree-l2"><a class="reference internal" href="discovering_network.html#broadcast-network">Broadcast network</a></li>
<li class="toctree-l2"><a class="reference internal" href="discovering_network.html#request-nodes">Request nodes</a></li>
<li class="toctree-l2"><a class="reference internal" href="discovering_network.html#values-querying">Values querying</a></li>
<li class="toctree-l2"><a class="reference internal" href="discovering_network.html#command-class-discovering">Command class discovering</a></li>
<li class="toctree-l2"><a class="reference internal" href="discovering_network.html#more-servers">More servers</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href=""> Hello World 4 : interacting with our server</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#goal">Goal</a></li>
<li class="toctree-l2"><a class="reference internal" href="#state-machine">State machine</a></li>
<li class="toctree-l2"><a class="reference internal" href="#wake-up-baby">Wake up baby</a></li>
<li class="toctree-l2"><a class="reference internal" href="#critical-temperature">Critical temperature</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="more.html"> Create and share</a><ul>
<li class="toctree-l2"><a class="reference internal" href="more.html#why">Why</a></li>
<li class="toctree-l2"><a class="reference internal" href="more.html#how">How</a></li>
<li class="toctree-l2"><a class="reference internal" href="more.html#bus-aggregation-vs-bus-extension">Bus aggregation vs bus extension</a></li>
<li class="toctree-l2"><a class="reference internal" href="more.html#remote-development">Remote development</a></li>
<li class="toctree-l2"><a class="reference internal" href="more.html#tests">Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="more.html#examples">Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="more.html#i-want-more">I want more</a></li>
<li class="toctree-l2"><a class="reference internal" href="more.html#i-want-to-help">I want to help</a></li>
<li class="toctree-l2"><a class="reference internal" href="more.html#documentation">Documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="using_doc.html"> Using documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="using_doc.html#the-header">The header</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="discovering_network.html" title="Previous Chapter: Discovering network"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Discovering n...</span>
    </a>
  </li>
  <li>
    <a href="more.html" title="Next Chapter: Create and share"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Create and share &raquo;</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="helloword-v4">
<h1>HelloWord V4<a class="headerlink" href="#helloword-v4" title="Permalink to this headline">¶</a></h1>
<div class="section" id="goal">
<h2>Goal<a class="headerlink" href="#goal" title="Permalink to this headline">¶</a></h2>
<p>Back to our Rapsberry pi server : .
For the impatient that did not use a raspberry, you can jump <a class="reference internal" href="more.html"><em>here</em></a></p>
</div>
<div class="section" id="state-machine">
<h2>State machine<a class="headerlink" href="#state-machine" title="Permalink to this headline">¶</a></h2>
<p>Look at the spyer. At startup, the server publish all its values but after a while it became silently :</p>
<div class="code bash highlight-python"><div class="highlight"><pre>/values/user/0225/0003/voltage 0 {&quot;help&quot;: &quot;The voltage of the CPU&quot;, &quot;voice_uuid&quot;: null, &quot;max&quot;: null, &quot;reply_hadd&quot;: null, &quot;node_uuid&quot;: &quot;tutorial2__cpu&quot;, &quot;entry
_name&quot;: &quot;sensor_voltage&quot;, &quot;genre&quot;: 2, &quot;poll_delay&quot;: 300, &quot;data&quot;: 1.35, &quot;is_polled&quot;: true, &quot;is_writeonly&quot;: false, &quot;list_items&quot;: null, &quot;index&quot;: 0, &quot;uuid&quot;: &quot;volt
age&quot;, &quot;is_readonly&quot;: true, &quot;min&quot;: null, &quot;default&quot;: null, &quot;type&quot;: 3, &quot;cmd_class&quot;: 49, &quot;hadd&quot;: &quot;0225/0003&quot;, &quot;label&quot;: &quot;CPUVolt&quot;, &quot;units&quot;: &quot;V&quot;}
/values/user/0225/0002/temperature 0 {&quot;help&quot;: &quot;The temperature&quot;, &quot;voice_uuid&quot;: null, &quot;max&quot;: null, &quot;reply_hadd&quot;: null, &quot;node_uuid&quot;: &quot;tutorial2__temperature&quot;, &quot;
entry_name&quot;: &quot;sensor_temperature&quot;, &quot;genre&quot;: 2, &quot;poll_delay&quot;: 300, &quot;data&quot;: 85.0, &quot;is_polled&quot;: true, &quot;is_writeonly&quot;: false, &quot;list_items&quot;: null, &quot;index&quot;: 0, &quot;uui
d&quot;: &quot;temperature&quot;, &quot;is_readonly&quot;: true, &quot;min&quot;: null, &quot;default&quot;: null, &quot;type&quot;: 3, &quot;cmd_class&quot;: 49, &quot;hadd&quot;: &quot;0225/0002&quot;, &quot;label&quot;: &quot;Temp&quot;, &quot;units&quot;: &quot;\u00b0C&quot;}
/dhcp/heartbeat/0225/0002 0 ONLINE
/dhcp/heartbeat/0225/0004 0 ONLINE
/dhcp/heartbeat/0225/0003 0 ONLINE
/dhcp/heartbeat/0225/0001 0 ONLINE
/dhcp/heartbeat/0225/0000 0 ONLINE
/dhcp/heartbeat/0225/0002 0 ONLINE
/dhcp/heartbeat/0225/0004 0 ONLINE
/dhcp/heartbeat/0225/0003 0 ONLINE
/dhcp/heartbeat/0225/0001 0 ONLINE
/dhcp/heartbeat/0225/0000 0 ONLINE
/values/user/0225/0000/tutorial2_state 0 {&quot;help&quot;: &quot;The state of the fsm.&quot;, &quot;voice_uuid&quot;: null, &quot;max&quot;: null, &quot;reply_hadd&quot;: null, &quot;node_uuid&quot;: &quot;tutorial2&quot;, &quot;entry_name&quot;: &quot;sensor_string&quot;, &quot;genre&quot;: 2, &quot;poll_delay&quot;: 900, &quot;data&quot;: &quot;sleeping&quot;, &quot;is_polled&quot;: true, &quot;is_writeonly&quot;: false, &quot;list_items&quot;: null, &quot;index&quot;: 0, &quot;uuid&quot;: &quot;tutorial2_state&quot;, &quot;is_readonly&quot;: true, &quot;min&quot;: null, &quot;default&quot;: null, &quot;type&quot;: 8, &quot;cmd_class&quot;: 49, &quot;hadd&quot;: &quot;0225/0000&quot;, &quot;label&quot;: &quot;State&quot;, &quot;units&quot;: null}
/dhcp/heartbeat/0225/0002 0 ONLINE
/dhcp/heartbeat/0225/0004 0 ONLINE
/dhcp/heartbeat/0225/0003 0 ONLINE
/dhcp/heartbeat/0225/0001 0 ONLINE
/dhcp/heartbeat/0225/0000 0 ONLINE
/dhcp/heartbeat/0225/0002 0 ONLINE
/dhcp/heartbeat/0225/0004 0 ONLINE
/dhcp/heartbeat/0225/0003 0 ONLINE
/dhcp/heartbeat/0225/0001 0 ONLINE
/dhcp/heartbeat/0225/0000 0 ONLINE
</pre></div>
</div>
<p>That&#8217;s because we enter in mode sleep. As publish in the last value : &#8220;data&#8221;: &#8220;sleeping&#8221;. And we publish this value every 900seconds : &#8220;poll_delay&#8221;: 900.</p>
<p>That&#8217;s done in the check_heartbeat method :</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">check_heartbeat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check that the component is &#39;available&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c">#~ for bus in self.buses:</span>
        <span class="c">#~ res = res and self.buses[bus].check_heartbeat()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;[</span><span class="si">%s</span><span class="s">] - sensors </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">polled_sensors</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s">&#39;booting&#39;</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">polled_sensors</span><span class="p">):</span>
        <span class="c">#We try to enter in sleeping mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="s">&#39;booting&#39;</span>
</pre></div>
</div>
<p>That&#8217;s not the fastest way to do it but not the worst. We need to check that all nodes are up before changing of state.
If the state is not change, the node associated to the bus will send an &#8216;OFFLINE&#8217; heartbeat.</p>
<p>We add a condition for the state machine : values needs to be up to change the state. Of course, no need to check conditions to get into sleeping state.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">condition_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;[</span><span class="si">%s</span><span class="s">] - condition_values&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">polled_sensors</span><span class="p">)</span>
</pre></div>
</div>
<p>And we add on_enter_{state} functions. For example, when entering in reporting mode, we activate the polls  :</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">on_enter_reporting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;[</span><span class="si">%s</span><span class="s">] - on_enter_reporting&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bus_acquire</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeman</span><span class="o">.</span><span class="n">find_value</span><span class="p">(</span><span class="s">&#39;led&#39;</span><span class="p">,</span> <span class="s">&#39;blink&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="s">&#39;heartbeat&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeman</span><span class="o">.</span><span class="n">add_polls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polled_sensors</span><span class="p">,</span> <span class="n">slow_start</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="c">#In sleeping mode, send the state of the fsm every 900 seconds</span>
        <span class="c">#We update poll_delay directly to not update the value in configfile</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeman</span><span class="o">.</span><span class="n">find_bus_value</span><span class="p">(</span><span class="s">&#39;state&#39;</span><span class="p">)</span>
        <span class="n">state</span><span class="o">.</span><span class="n">poll_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeman</span><span class="o">.</span><span class="n">find_bus_value</span><span class="p">(</span><span class="s">&#39;state_poll&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
        <span class="n">overheat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeman</span><span class="o">.</span><span class="n">find_bus_value</span><span class="p">(</span><span class="s">&#39;overheat&#39;</span><span class="p">)</span>
        <span class="n">overheat</span><span class="o">.</span><span class="n">poll_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeman</span><span class="o">.</span><span class="n">find_bus_value</span><span class="p">(</span><span class="s">&#39;overheat_poll&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeman</span><span class="o">.</span><span class="n">publish_value</span><span class="p">(</span><span class="n">overheat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeman</span><span class="o">.</span><span class="n">add_polls</span><span class="p">([</span><span class="n">state</span><span class="p">,</span> <span class="n">overheat</span><span class="p">],</span> <span class="n">slow_start</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&quot;[</span><span class="si">%s</span><span class="s">] - Error in on_enter_reporting&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bus_release</span><span class="p">()</span>
</pre></div>
</div>
<p>We also publish the overheat value immediatly :</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="bp">self</span><span class="o">.</span><span class="n">nodeman</span><span class="o">.</span><span class="n">publish_value</span><span class="p">(</span><span class="n">overheat</span><span class="p">)</span>
</pre></div>
</div>
<p>It&#8217;s time to add some code to interact with the state machine ... and speak about the value_factory.
Values are used to interact with nodes : update config, poll, location, get temperature, ...
To allow developpers to share these interactions, there is the value factory.
You can collect values in your local values factory using :</p>
<div class="code bash highlight-python"><div class="highlight"><pre>jnt_collect -t janitoo.values
</pre></div>
</div>
<p>For example, the value sensor_temperature is used to send a temperature :D
It defines the right units, command class, label, ...</p>
<p>We want to interact with the finish state machine, so transition_fsm is a good choice :</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">uuid</span><span class="o">=</span><span class="s">&quot;{:s}_transition&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">OID</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">uuid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_factory</span><span class="p">[</span><span class="s">&#39;transition_fsm&#39;</span><span class="p">](</span><span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="n">uuid</span><span class="p">,</span>
    <span class="n">node_uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
    <span class="n">list_items</span><span class="o">=</span><span class="p">[</span> <span class="n">v</span><span class="p">[</span><span class="s">&#39;trigger&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span> <span class="p">],</span>
    <span class="n">fsm_bus</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">poll_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">uuid</span><span class="p">]</span><span class="o">.</span><span class="n">create_poll_value</span><span class="p">()</span>
<span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">poll_value</span><span class="o">.</span><span class="n">uuid</span><span class="p">]</span> <span class="o">=</span> <span class="n">poll_value</span>
</pre></div>
</div>
<p>We defined a new value using &#8216;transition_fsm&#8217; with a list of valid items populated from the transition state machine and a refrence to the bus itself.
And that&#8217;s all. All the job is done automatically : <a class="reference external" href="https://github.com/bibi21000/janitoo_factory/blob/master/src/janitoo_factory/values/action.py#L230">https://github.com/bibi21000/janitoo_factory/blob/master/src/janitoo_factory/values/action.py#L230</a></p>
<p>As we want to poll this value, we also add a linked poll value.</p>
</div>
<div class="section" id="wake-up-baby">
<h2>Wake up baby<a class="headerlink" href="#wake-up-baby" title="Permalink to this headline">¶</a></h2>
<p>It&#8217;s time to wake-up the state machine. At first, we need to find the right value :</p>
<div class="code bash highlight-python"><div class="highlight"><pre>$ jnt_query node --hadd 0225/0000 --vuuid request_info_basics
</pre></div>
</div>
<div class="code bash highlight-python"><div class="highlight"><pre>request_info_basics
----------
hadd       uuid                           idx  data                      units      type  genre cmdclass help
0225/0004  switch                         0    off                       None       5     1     37       A switch. Valid values are : [&#39;on&#39;, &#39;off&#39;]
0225/0004  blink                          0    off                       None       5     1     12803    Blink
0225/0000  tutorial2_transition           0    None                      None       5     1     0        Send a transition to the fsm
</pre></div>
</div>
<p>Get more informations on this value :</p>
<div class="code bash highlight-python"><div class="highlight"><pre>$ jnt_query query --host=192.168.14.65 --hadd 0225/0000 --genre basic --uuid tutorial2_transition --cmdclass 4272 --type 1 --readonly True
</pre></div>
</div>
<div class="code bash highlight-python"><div class="highlight"><pre>tutorial2_transition
----------
hadd       uuid                      idx  data                      units      type  genre cmdclass list_items help
0225/0000  tutorial2_transition      0    None                      None       5     1     4272     [u&#39;wakeup&#39;, u&#39;report&#39;, u&#39;sleep&#39;, u&#39;ring&#39;] Trigger a transition on the fsm or get the last triggered
</pre></div>
</div>
<p>And trigger a transition from [u&#8217;wakeup&#8217;, u&#8217;report&#8217;, u&#8217;sleep&#8217;, u&#8217;ring&#8217;] :</p>
<div class="code bash highlight-python"><div class="highlight"><pre>$ jnt_query query --host=192.168.14.65 --hadd 0225/0000 --genre basic --uuid tutorial2_transition --cmdclass 4272 --type 1 --writeonly True --data wakeup
</pre></div>
</div>
<div class="code bash highlight-python"><div class="highlight"><pre>tutorial2_transition
----------
hadd       uuid                      idx  data                      units      type  genre cmdclass list_items help
0225/0000  tutorial2_transition      0    wakeup                    None       5     1     4272     [u&#39;wakeup&#39;, u&#39;report&#39;, u&#39;sleep&#39;, u&#39;ring&#39;] Trigger a transition on the fsm or get the last triggered
</pre></div>
</div>
<p>Look at spyer :</p>
<div class="code bash highlight-python"><div class="highlight"><pre>/values/user/0225/0003/frequency 0 {&quot;help&quot;: &quot;The frequency of the CPU&quot;, &quot;voice_uuid&quot;: null, &quot;max&quot;: null, &quot;reply_hadd&quot;: null, &quot;node_uuid&quot;: &quot;tutorial2__cpu&quot;, &quot;entry_name&quot;: &quot;sensor_frequency&quot;, &quot;genre&quot;: 2, &quot;poll_delay&quot;: 300, &quot;data&quot;: 1000, &quot;is_polled&quot;: true, &quot;is_writeonly&quot;: false, &quot;list_items&quot;: null, &quot;index&quot;: 0, &quot;uuid&quot;: &quot;frequency&quot;, &quot;is_readonly&quot;: true, &quot;min&quot;: null, &quot;default&quot;: null, &quot;type&quot;: 3, &quot;cmd_class&quot;: 49, &quot;hadd&quot;: &quot;0225/0003&quot;, &quot;label&quot;: &quot;CPUFreq&quot;, &quot;units&quot;: &quot;MHz&quot;}
/values/basic/0225/0004/blink 0 {&quot;help&quot;: &quot;Blink&quot;, &quot;reply_hadd&quot;: null, &quot;entry_name&quot;: &quot;blink&quot;, &quot;poll_delay&quot;: 300, &quot;is_writeonly&quot;: false, &quot;list_items&quot;: null, &quot;index&quot;: 0, &quot;uuid&quot;: &quot;blink&quot;, &quot;min&quot;: null, &quot;delays&quot;: {&quot;info&quot;: {&quot;on&quot;: 0.6, &quot;off&quot;: 60}, &quot;off&quot;: {&quot;on&quot;: 0, &quot;off&quot;: 1}, &quot;blink&quot;: {&quot;on&quot;: 0.6, &quot;off&quot;: 2.5}, &quot;warning&quot;: {&quot;on&quot;: 0.6, &quot;off&quot;: 5}, &quot;notify&quot;: {&quot;on&quot;: 0.6, &quot;off&quot;: 10}, &quot;heartbeat&quot;: {&quot;on&quot;: 0.5, &quot;off&quot;: 300}, &quot;alert&quot;: {&quot;on&quot;: 0.6, &quot;off&quot;: 1}}, &quot;cmd_class&quot;: 12803, &quot;hadd&quot;: &quot;0225/0004&quot;, &quot;label&quot;: &quot;Blink&quot;, &quot;units&quot;: null, &quot;type&quot;: 5, &quot;max&quot;: null, &quot;genre&quot;: 1, &quot;data&quot;: &quot;heartbeat&quot;, &quot;is_polled&quot;: true, &quot;node_uuid&quot;: &quot;tutorial2__led&quot;, &quot;voice_uuid&quot;: null, &quot;is_readonly&quot;: false, &quot;default&quot;: &quot;off&quot;}
/values/user/0225/0000/tutorial2_temperature 0 {&quot;help&quot;: &quot;The average temperature of tutorial.&quot;, &quot;voice_uuid&quot;: null, &quot;max&quot;: null, &quot;reply_hadd&quot;: null, &quot;node_uuid&quot;: &quot;tutorial2&quot;, &quot;entry_name&quot;: &quot;sensor_temperature&quot;, &quot;genre&quot;: 2, &quot;poll_delay&quot;: 300, &quot;data&quot;: null, &quot;is_polled&quot;: true, &quot;is_writeonly&quot;: false, &quot;list_items&quot;: null, &quot;index&quot;: 0, &quot;uuid&quot;: &quot;tutorial2_temperature&quot;, &quot;is_readonly&quot;: true, &quot;min&quot;: null, &quot;default&quot;: null, &quot;type&quot;: 3, &quot;cmd_class&quot;: 49, &quot;hadd&quot;: &quot;0225/0000&quot;, &quot;label&quot;: &quot;Temp&quot;, &quot;units&quot;: &quot;\u00b0C&quot;}
/values/basic/0225/0000/tutorial2_transition 0 {&quot;help&quot;: &quot;Trigger a transition on the fsm or get the last triggered&quot;, &quot;voice_uuid&quot;: null, &quot;max&quot;: null, &quot;reply_hadd&quot;: null, &quot;node_uuid&quot;: &quot;tutorial2&quot;, &quot;entry_name&quot;: &quot;transition_fsm&quot;, &quot;genre&quot;: 1, &quot;poll_delay&quot;: 60, &quot;data&quot;: &quot;wakeup&quot;, &quot;is_polled&quot;: true, &quot;is_writeonly&quot;: false, &quot;list_items&quot;: [&quot;wakeup&quot;, &quot;report&quot;, &quot;sleep&quot;, &quot;ring&quot;], &quot;index&quot;: 0, &quot;uuid&quot;: &quot;tutorial2_transition&quot;, &quot;is_readonly&quot;: false, &quot;min&quot;: null, &quot;default&quot;: null, &quot;cmd_class&quot;: 4272, &quot;hadd&quot;: &quot;0225/0000&quot;, &quot;label&quot;: &quot;Transit&quot;, &quot;units&quot;: null, &quot;type&quot;: 5}
/nodes/0225/0000/request 0 {&quot;reply_hadd&quot;: &quot;9999/9990&quot;, &quot;uuid&quot;: &quot;tutorial2_transition&quot;, &quot;is_readonly&quot;: true, &quot;genre&quot;: 1, &quot;data&quot;: null, &quot;cmd_class&quot;: 4272, &quot;hadd&quot;: &quot;0225/0000&quot;, &quot;is_writeonly&quot;: false}
/nodes/9999/9990/reply 0 {&quot;help&quot;: &quot;Trigger a transition on the fsm or get the last triggered&quot;, &quot;voice_uuid&quot;: null, &quot;max&quot;: null, &quot;reply_hadd&quot;: &quot;9999/9990&quot;, &quot;node_uuid&quot;: &quot;tutorial2&quot;, &quot;entry_name&quot;: &quot;transition_fsm&quot;, &quot;genre&quot;: 1, &quot;poll_delay&quot;: 60, &quot;data&quot;: &quot;wakeup&quot;, &quot;is_polled&quot;: true, &quot;is_writeonly&quot;: false, &quot;list_items&quot;: [&quot;wakeup&quot;, &quot;report&quot;, &quot;sleep&quot;, &quot;ring&quot;], &quot;index&quot;: 0, &quot;uuid&quot;: &quot;tutorial2_transition&quot;, &quot;is_readonly&quot;: true, &quot;min&quot;: null, &quot;default&quot;: null, &quot;cmd_class&quot;: 4272, &quot;hadd&quot;: &quot;0225/0000&quot;, &quot;label&quot;: &quot;Transit&quot;, &quot;units&quot;: null, &quot;type&quot;: 5}
/values/basic/0225/0000/tutorial2_transition 0 {&quot;help&quot;: &quot;Trigger a transition on the fsm or get the last triggered&quot;, &quot;voice_uuid&quot;: null, &quot;max&quot;: null, &quot;reply_hadd&quot;: &quot;9999/9990&quot;, &quot;node_uuid&quot;: &quot;tutorial2&quot;, &quot;entry_name&quot;: &quot;transition_fsm&quot;, &quot;genre&quot;: 1, &quot;poll_delay&quot;: 60, &quot;data&quot;: &quot;wakeup&quot;, &quot;is_polled&quot;: true, &quot;is_writeonly&quot;: false, &quot;list_items&quot;: [&quot;wakeup&quot;, &quot;report&quot;, &quot;sleep&quot;, &quot;ring&quot;], &quot;index&quot;: 0, &quot;uuid&quot;: &quot;tutorial2_transition&quot;, &quot;is_readonly&quot;: true, &quot;min&quot;: null, &quot;default&quot;: null, &quot;cmd_class&quot;: 4272, &quot;hadd&quot;: &quot;0225/0000&quot;, &quot;label&quot;: &quot;Transit&quot;, &quot;units&quot;: null, &quot;type&quot;: 5}
/dhcp/heartbeat/0225/0000 0 ONLINE
/dhcp/heartbeat/0225/0002 0 ONLINE
/dhcp/heartbeat/0225/0004 0 ONLINE
/dhcp/heartbeat/0225/0003 0 ONLINE
/dhcp/heartbeat/0225/0001 0 ONLINE
/dhcp/heartbeat/0225/0000 0 ONLINE
/dhcp/heartbeat/0225/0002 0 ONLINE
/values/user/0225/0000/tutorial2_state 0 {&quot;help&quot;: &quot;The state of the fsm.&quot;, &quot;voice_uuid&quot;: null, &quot;max&quot;: null, &quot;reply_hadd&quot;: null, &quot;node_uuid&quot;: &quot;tutorial2&quot;, &quot;entry_name&quot;: &quot;sensor_string&quot;, &quot;genre&quot;: 2, &quot;poll_delay&quot;: 60, &quot;data&quot;: &quot;reporting&quot;, &quot;is_polled&quot;: true, &quot;is_writeonly&quot;: false, &quot;list_items&quot;: null, &quot;index&quot;: 0, &quot;uuid&quot;: &quot;tutorial2_state&quot;, &quot;is_readonly&quot;: true, &quot;min&quot;: null, &quot;default&quot;: null, &quot;type&quot;: 8, &quot;cmd_class&quot;: 49, &quot;hadd&quot;: &quot;0225/0000&quot;, &quot;label&quot;: &quot;State&quot;, &quot;units&quot;: null}
</pre></div>
</div>
<p>The values are published regulary. You should also see your led blinking in heartbeat mode.</p>
<p>A note ont the state machine. Writing this tutorial, I added a new bus with an integrated state machine : <a class="reference external" href="https://github.com/bibi21000/janitoo_factory/blob/master/src/janitoo_factory/buses/fsm.py">https://github.com/bibi21000/janitoo_factory/blob/master/src/janitoo_factory/buses/fsm.py</a>.
It&#8217;s a better idea to inherit from it. It use a timer to speed up the boot process.</p>
</div>
<div class="section" id="critical-temperature">
<h2>Critical temperature<a class="headerlink" href="#critical-temperature" title="Permalink to this headline">¶</a></h2>
<p>We want to notify when a temperature become critical. To do that, we add 2 values and a thread timer that will check temperatures.
If a temperature is higher than the critical one, we transit in ringing mode.</p>
<p>The on_check timer start/stop is managed entering / exiting the sleeping state :</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">on_enter_sleeping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;[</span><span class="si">%s</span><span class="s">] - on_enter_sleeping&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bus_acquire</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_check</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeman</span><span class="o">.</span><span class="n">remove_polls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polled_sensors</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeman</span><span class="o">.</span><span class="n">find_value</span><span class="p">(</span><span class="s">&#39;led&#39;</span><span class="p">,</span> <span class="s">&#39;blink&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="s">&#39;off&#39;</span>
        <span class="c">#In sleeping mode, send the state of the fsm every 900 seconds</span>
        <span class="c">#We update poll_delay directly to nto update the value in config file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeman</span><span class="o">.</span><span class="n">find_bus_value</span><span class="p">(</span><span class="s">&#39;state&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">poll_delay</span> <span class="o">=</span> <span class="mi">900</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&quot;[</span><span class="si">%s</span><span class="s">] - Error in on_enter_sleeping&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bus_release</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">on_exit_sleeping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;[</span><span class="si">%s</span><span class="s">] - on_exit_sleeping&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">on_check</span><span class="p">()</span>
</pre></div>
</div>
<p>The overheat value is updated in the on_check timer :</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">criticals</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="s">&#39;ringing&#39;</span><span class="p">:</span>
        <span class="c">#We should notify a security problem : fire ?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeman</span><span class="o">.</span><span class="n">find_bus_value</span><span class="p">(</span><span class="s">&#39;overheat&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ring</span><span class="p">()</span>
<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s">&#39;ringing&#39;</span><span class="p">:</span>
    <span class="c">#We should notify a security problem : fire ?</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nodeman</span><span class="o">.</span><span class="n">find_bus_value</span><span class="p">(</span><span class="s">&#39;overheat&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
</pre></div>
</div>
<p>In ringing state, we are more verbose :</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">on_enter_ringing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;[</span><span class="si">%s</span><span class="s">] - on_enter_ringing&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bus_acquire</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeman</span><span class="o">.</span><span class="n">find_value</span><span class="p">(</span><span class="s">&#39;led&#39;</span><span class="p">,</span> <span class="s">&#39;blink&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="s">&#39;warning&#39;</span>
        <span class="c">#In sleeping mode, send the state of the fsm every 900 seconds</span>
        <span class="c">#We update poll_delay directly to not update the value in configfile</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeman</span><span class="o">.</span><span class="n">find_bus_value</span><span class="p">(</span><span class="s">&#39;state&#39;</span><span class="p">)</span>
        <span class="n">state</span><span class="o">.</span><span class="n">poll_delay</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeman</span><span class="o">.</span><span class="n">find_bus_value</span><span class="p">(</span><span class="s">&#39;state_poll&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span> <span class="o">/</span> <span class="mi">3</span>
        <span class="n">overheat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeman</span><span class="o">.</span><span class="n">find_bus_value</span><span class="p">(</span><span class="s">&#39;overheat&#39;</span><span class="p">)</span>
        <span class="n">overheat</span><span class="o">.</span><span class="n">poll_delay</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeman</span><span class="o">.</span><span class="n">find_bus_value</span><span class="p">(</span><span class="s">&#39;overheat_poll&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span> <span class="o">/</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeman</span><span class="o">.</span><span class="n">publish_value</span><span class="p">(</span><span class="n">overheat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeman</span><span class="o">.</span><span class="n">add_polls</span><span class="p">([</span><span class="n">state</span><span class="p">,</span> <span class="n">overheat</span><span class="p">],</span> <span class="n">slow_start</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&quot;[</span><span class="si">%s</span><span class="s">] - Error in on_enter_ringing&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bus_release</span><span class="p">()</span>
</pre></div>
</div>
<p>We also launch the on_check temperature more frequently :</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_timer</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_started</span><span class="p">:</span>
    <span class="n">timer_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bus_value</span><span class="p">(</span><span class="s">&#39;timer_delay&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s">&#39;ringing&#39;</span><span class="p">:</span>
        <span class="n">timer_delay</span> <span class="o">=</span> <span class="n">timer_delay</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_timer</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="n">timer_delay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_check</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p>It&#8217;s time to ring :</p>
<div class="code bash highlight-python"><div class="highlight"><pre>$ jnt_query query --host=192.168.14.65 --hadd 0225/0000 --genre basic --uuid tutorial2_transition --cmdclass 4272 --type 1 --writeonly True --data ring
</pre></div>
</div>
<p>And check that the state is ringing. You can also look at your led, should blink faster :</p>
<div class="code bash highlight-python"><div class="highlight"><pre>$ jnt_query node --host=192.168.14.65 --hadd 0225/0000 --vuuid request_info_basics
</pre></div>
</div>
<div class="code bash highlight-python"><div class="highlight"><pre>----------
hadd       uuid                           idx  data                      units      type  genre cmdclass help
0225/0004  switch                         0    off                       None       5     1     37       A switch. Valid values are : [&#39;on&#39;, &#39;off&#39;]
0225/0004  blink                          0    warning                   None       5     1     12803    Blink
0225/0000  tutorial2_transition           0    ring                      None       5     1     4272     Trigger a transition on the fsm or get the last triggered
0225/0000  tutorial2_state                0    ringing                   None       8     1     49       The state of the fsm.
</pre></div>
</div>
<p>After a while, the state returns in reporting state :</p>
<div class="code bash highlight-python"><div class="highlight"><pre>$ jnt_query node --host=192.168.14.65 --hadd 0225/0000 --vuuid request_info_basicsrequest_info_basics
</pre></div>
</div>
<div class="code bash highlight-python"><div class="highlight"><pre>----------
hadd       uuid                           idx  data                      units      type  genre cmdclass help
0225/0004  switch                         0    off                       None       5     1     37       A switch. Valid values are : [&#39;on&#39;, &#39;off&#39;]
0225/0004  blink                          0    heartbeat                 None       5     1     12803    Blink
0225/0000  tutorial2_transition           0    wakeup                    None       5     1     4272     Trigger a transition on the fsm or get the last triggered
0225/0000  tutorial2_state                0    reporting                 None       8     1     49       The state of the fsm.
</pre></div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2014,2015,2016 Sébastien GALLET aka bibi2100 &lt;bibi21000@gmail.com&gt;.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>